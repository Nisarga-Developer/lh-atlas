<dom-module id="atlas-control">

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="https://polygit.org/polymer+v2.0.0/shadycss+webcomponents+1.0.0/components/iron-ajax/iron-ajax.html">
<script src="https://www.gstatic.com/firebasejs/4.8.2/firebase.js"></script>

        <script>
            // Initialize Firebase
            var config = {
                apiKey: "AIzaSyDRxNTvFO62jOQTxG5Th8-AN81xmUc7pAo",
                authDomain: "extensions-3caad.firebaseapp.com",
                databaseURL: "https://extensions-3caad.firebaseio.com",
                projectId: "extensions-3caad",
                storageBucket: "extensions-3caad.appspot.com",
                messagingSenderId: "492740598517"
            };
            firebase.initializeApp(config);
            
            var title, location, latitude, longitude, email, phone, version, encounters;
        
        function varUpdater(titleF, locationF, latitudeF, longitudeF, emailF, phoneF, versionF, encountersF) {
            title = titleF;
            location = locationF;
            latitude = latitudeF;
            email = emailF;
            phone = phoneF;
            version = versionF;
            encounters = encountersF;
        }
      </script>

  <template>
      <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
      
  </template>

  <script>
    class PatientDemographics extends Polymer.Element {
      static get is() {
          return 'atlas-control';
      }
    
      static get properties() {
        return {
            username: {
                type: String,
                observer: "valChanged"
            },
            password: {
                type: String,
                observer: "valChanged"
            },
            title: {
                type: String,
                observer: "valChanged"
            },
            email: {
                type: String,
                observer: "valChanged"
            },
            phone: {
                type: String,
                observer: "valChanged"
            },
            latitude: {
                type: Number,
                observer: "valChanged"
            },
            longitude: {
                type: Number,
                observer: "valChanged"
            },
            location: {
                type: String,
                observer: "valChanged"
            },
            encounters: {
                type: String,
                observer: "valChanged"
            },
            version: {
                type: String,
                observer: "valChanged"
            }
        }
      }
      constructor() {
        super();
      }
        
        
        
        loginUser() {
            loginUserWithCredentials(this.username, this.password);
        }
        
        addToolkitUserMarker() {
            createMarker("toolkit");
        }
        
        addRadiologyUserMarker() {
            createMarker("radiology");
        }
        
        addEventUserMarker() {
            createMarker("event");
        }
        
        addEhrUserMarker() {
            createMarker("ehr");
        }
        
        valChanged(){
            varUpdater(this.title, this.location, this.latitude, this.longitude, this.email, this.phone, this.version, this.encounters);
        }
      
    }
      
    customElements.define(PatientDemographics.is, PatientDemographics);
  </script>
    
    <script>
        var loggedIn = false;
        
        
        function loginUserWithCredentials(user,pass) {
            firebase.auth().signInWithEmailAndPassword(user,pass).catch(function(error) {
                var errorCode = error.code;
                var errorMessage = error.message;
                console.log(errorCode);
                console.log(errorMessage);
                console.log("Failed to log in to atlas db");
            }).then(function(){
                loggedIn = true;
                console.log("Logged in to atlas db");
                console.log(loggedIn);
                console.log(this.title);
                console.log(this.version);
                console.log(this.location);
            });
        }
        
        function createMarker(type) {
            if(loggedIn){
                if(type == "event") {
                    firebase.database().ref('lh-atlas/' + title).set({
                        type: type,
                        location: location,
                        coords: '{ "lat":' + latitude + ', "lng":' + longitude + '}',
                        name: name,
                        lastUpdated: Date()
                    });
                } else {
                    firebase.database().ref('lh-atlas/' + title).set({
                        type: type,
                        location: location,
                        coords: '{ "lat":' + latitude + ', "lng":' + longitude + '}',
                        contactEmail: email,
                        contactPhone: phone,
                        version: version,
                        name: this.title,
                        encounters: encounters,
                        lastUpdated: Date()
                    });
                }
            }
        }
    </script>

</dom-module>
